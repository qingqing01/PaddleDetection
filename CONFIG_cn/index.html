<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>配置模块 - PaddleDetection Docs</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u914d\u7f6e\u6a21\u5757";
    var mkdocs_page_input_path = "CONFIG_cn.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> PaddleDetection Docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../index.md">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../docs/INSTALL.md">Installation</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../docs/QUICK_STARTED.md">Quick start</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../docs/MODEL_ZOO.md">Modle Zoo</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Deployment</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../docs/EXPORT_MODEL.md">Export model</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">PaddleDetection Docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>配置模块</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="_1">配置模块</h1>
<h2 id="_2">简介</h2>
<p>为了使配置过程更加自动化并减少配置错误，PaddleDetection的配置管理采取了较为严谨的设计。</p>
<h2 id="_3">设计思想</h2>
<p>目前主流框架全局配置基本是一个Python dict，这种设计对配置的检查并不严格，拼写错误或者遗漏的配置项往往会造成训练过程中的严重错误，进而造成时间及资源的浪费。为了避免这些陷阱，从自动化和静态分析的原则出发，PaddleDetection采用了一种用户友好、 易于维护和扩展的配置设计。</p>
<h2 id="_4">基本设计</h2>
<p>利用Python的反射机制，PaddleDection的配置系统从Python类的构造函数抽取多种信息 - 如参数名、初始值、参数注释、数据类型（如果给出type hint）- 来作为配置规则。 这种设计便于设计的模块化，提升可测试性及扩展性。</p>
<h3 id="api">API</h3>
<p>配置系统的大多数功能由 <code>ppdet.core.workspace</code> 模块提供</p>
<ul>
<li><code>register</code>: 装饰器，将类注册为可配置模块；能够识别类定义中的一些特殊标注。<ul>
<li><code>__category__</code>: 为便于组织，模块可以分为不同类别。</li>
<li><code>__inject__</code>: 如果模块由多个子模块组成，可以这些子模块实例作为构造函数的参数注入。对应的默认值及配置项可以是类名字符串，yaml序列化的对象，指向序列化对象的配置键值或者Python dict（构造函数需要对其作出处理，参见下面的例子）。</li>
<li><code>__op__</code>: 配合 <code>__append_doc__</code> （抽取目标OP的 注释）使用，可以方便快速的封装PaddlePaddle底层OP。</li>
</ul>
</li>
<li><code>serializable</code>: 装饰器，利用 <a href="https://pyyaml.org/wiki/PyYAMLDocumentation">pyyaml</a> 的序列化机制，可以直接将一个类实例序列化及反序列化。</li>
<li><code>create</code>: 根据全局配置构造一个模块实例。</li>
<li><code>load_config</code> and <code>merge_config</code>: 加载yaml文件，合并命令行提供的配置项。</li>
</ul>
<h3 id="_5">示例</h3>
<p>以 <code>RPNHead</code> 模块为例，该模块包含多个PaddlePaddle OP，先将这些OP封装成类，并将其实例在构造 <code>RPNHead</code> 时注入。</p>
<pre><code class="python"># excerpt from `ppdet/modeling/ops.py`
from ppdet.core.workspace import register, serializable

# ... more operators

@register
@serializable
class GenerateProposals(object):
    # NOTE this class simply wraps a PaddlePaddle operator
    __op__ = fluid.layers.generate_proposals
    # NOTE docstring for args are extracted from PaddlePaddle OP
    __append_doc__ = True

    def __init__(self,
                 pre_nms_top_n=6000,
                 post_nms_top_n=1000,
                 nms_thresh=.5,
                 min_size=.1,
                 eta=1.):
        super(GenerateProposals, self).__init__()
        self.pre_nms_top_n = pre_nms_top_n
        self.post_nms_top_n = post_nms_top_n
        self.nms_thresh = nms_thresh
        self.min_size = min_size
        self.eta = eta

# ... more operators

# excerpt from `ppdet/modeling/anchor_heads/rpn_head.py`
from ppdet.core.workspace import register
from ppdet.modeling.ops import AnchorGenerator, RPNTargetAssign, GenerateProposals

@register
class RPNHead(object):
    &quot;&quot;&quot;
    RPN Head

    Args:
        anchor_generator (object): `AnchorGenerator` instance
        rpn_target_assign (object): `RPNTargetAssign` instance
        train_proposal (object): `GenerateProposals` instance for training
        test_proposal (object): `GenerateProposals` instance for testing
    &quot;&quot;&quot;
    __inject__ = [
        'anchor_generator', 'rpn_target_assign', 'train_proposal',
        'test_proposal'
    ]

    def __init__(self,
                 anchor_generator=AnchorGenerator().__dict__,
                 rpn_target_assign=RPNTargetAssign().__dict__,
                 train_proposal=GenerateProposals(12000, 2000).__dict__,
                 test_proposal=GenerateProposals().__dict__):
        super(RPNHead, self).__init__()
        self.anchor_generator = anchor_generator
        self.rpn_target_assign = rpn_target_assign
        self.train_proposal = train_proposal
        self.test_proposal = test_proposal
        if isinstance(anchor_generator, dict):
            self.anchor_generator = AnchorGenerator(**anchor_generator)
        if isinstance(rpn_target_assign, dict):
            self.rpn_target_assign = RPNTargetAssign(**rpn_target_assign)
        if isinstance(train_proposal, dict):
            self.train_proposal = GenerateProposals(**train_proposal)
        if isinstance(test_proposal, dict):
            self.test_proposal = GenerateProposals(**test_proposal)
</code></pre>

<p>对应的yaml配置如下，请注意这里给出的是 <strong>完整</strong> 配置，其中所有默认值配置项都可以省略。上面的例子中的模块所有的构造函数参数都提供了默认值，因此配置文件中可以完全略过其配置。</p>
<pre><code class="yaml">RPNHead:
  test_proposal:
    eta: 1.0
    min_size: 0.1
    nms_thresh: 0.5
    post_nms_top_n: 1000
    pre_nms_top_n: 6000
  train_proposal:
    eta: 1.0
    min_size: 0.1
    nms_thresh: 0.5
    post_nms_top_n: 2000
    pre_nms_top_n: 12000
  anchor_generator:
    # ...
  rpn_target_assign:
    # ...
</code></pre>

<p><code>RPNHead</code> 模块实际使用代码示例。</p>
<pre><code class="python">from ppdet.core.workspace import load_config, merge_config, create

load_config('some_config_file.yml')
merge_config(more_config_options_from_command_line)

rpn_head = create('RPNHead')
# ... code that use the created module!
</code></pre>

<p>配置文件用可以直接序列化模块实例，用 <code>!</code> 标示，如</p>
<pre><code class="yaml">LearningRate:
  base_lr: 0.01
  schedulers:
  - !PiecewiseDecay
    gamma: 0.1
    milestones: [60000, 80000]
  - !LinearWarmup
    start_factor: 0.3333333333333333
    steps: 500
</code></pre>

<p><a href="config_example/">示例配置文件</a>中给出了多种检测结构的完整配置文件，以及其中各个超参的简要说明。</p>
<h2 id="_6">安装依赖</h2>
<p>配置系统用到两个Python包，均为可选安装。</p>
<ul>
<li><a href="https://github.com/agronholm/typeguard">typeguard</a> 在Python 3中用来进行数据类型验证。</li>
<li><a href="https://github.com/rr-/docstring_parser">docstring_parser</a> 用来解析注释。</li>
</ul>
<p>如需安装，运行下面命令即可。</p>
<pre><code class="shell">pip install typeguard http://github.com/willthefrog/docstring_parser/tarball/master
</code></pre>

<h2 id="_7">相关工具</h2>
<p>为了方便用户配置，PaddleDection提供了一个工具 (<code>tools/configure.py</code>)， 共支持四个子命令：</p>
<ol>
<li><code>list</code>: 列出当前已注册的模块，如需列出具体类别的模块，可以使用 <code>--category</code> 指定。</li>
<li><code>help</code>: 显示指定模块的帮助信息，如描述，配置项，配置文件模板及命令行示例。</li>
<li><code>analyze</code>: 检查配置文件中的缺少或者多余的配置项以及依赖缺失，如果给出type hint， 还可以检查配置项中错误的数据类型。非默认配置也会高亮显示。</li>
<li>
<p><code>generate</code>: 根据给出的模块列表生成配置文件，默认生成完整配置，如果指定 <code>--minimal</code> ，生成最小配置，即省略所有默认配置项。例如，执行下列命令可以生成Faster R-CNN (<code>ResNet</code> backbone + <code>FPN</code>) 架构的配置文件:</p>
<p><code>shell
python tools/configure.py generate FasterRCNN ResNet RPNHead RoIAlign BBoxAssigner BBoxHead FasterRCNNTrainFeed FasterRCNNTestFeed LearningRate OptimizerBuilder</code></p>
<p>如需最小配置，运行：</p>
<p><code>shell
python tools/configure.py --minimal generate FasterRCNN BBoxHead</code></p>
</li>
</ol>
<h2 id="faq">FAQ</h2>
<p><strong>Q:</strong> 某些配置项会在多个模块中用到(如 <code>num_classes</code>)，如何避免在配置文件中多次重复设置？</p>
<p><strong>A:</strong> 框架提供了 <code>__shared__</code> 标记来实现配置的共享，用户可以标记参数，如 <code>__shared__ = ['num_classes']</code> ，配置数值作用规则如下：</p>
<ol>
<li>如果模块配置中提供了 <code>num_classes</code> ，会优先使用其数值。</li>
<li>如果模块配置中未提供 <code>num_classes</code> ，但配置文件中存在全局键值，那么会使用全局键值。</li>
<li>两者均为配置的情况下，将使用默认值(<code>81</code>)。</li>
</ol>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../mathjax-config.js" defer></script>
      <script src="../MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
