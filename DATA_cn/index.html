<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>数据模块 - PaddleDetection Docs</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u6570\u636e\u6a21\u5757";
    var mkdocs_page_input_path = "DATA_cn.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> PaddleDetection Docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../index.md">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../docs/INSTALL.md">Installation</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../docs/QUICK_STARTED.md">Quick start</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../docs/MODEL_ZOO.md">Modle Zoo</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Deployment</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../docs/EXPORT_MODEL.md">Export model</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">PaddleDetection Docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>数据模块</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="_1">数据模块</h1>
<h2 id="_2">介绍</h2>
<p>本模块是一个Python模块，用于加载数据并将其转换成适用于检测模型的训练、验证、测试所需要的格式——由多个np.ndarray组成的tuple数组，例如用于Faster R-CNN模型的训练数据格式为：<code>[(im, im_info, im_id, gt_bbox, gt_class, is_crowd), (...)]</code>。</p>
<h3 id="_3">实现</h3>
<p>该模块内部可分为4个子功能：数据解析、图片预处理、数据转换和数据获取接口。</p>
<p>我们采用<code>data.Dataset</code>表示一份数据，比如<code>COCO</code>数据包含3份数据，分别用于训练、验证和测试。原始数据存储与文件中，通过<code>data.source</code>加载到内存，然后使用<code>data.transform</code>对数据进行处理转换，最终通过<code>data.Reader</code>的接口可以获得用于训练、验证和测试的batch数据。</p>
<p>子功能介绍：</p>
<ol>
<li>数据解析  </li>
</ol>
<p>数据解析得到的是<code>data.Dataset</code>,实现逻辑位于<code>data.source</code>中。通过它可以实现解析不同格式的数据集，已支持的数据源包括：</p>
<ul>
<li>COCO数据源</li>
</ul>
<p>该数据集目前分为COCO2014和COCO2017，主要由json文件和image文件组成，其组织结构如下所示：</p>
<p><code>dataset/coco/
  ├── annotations
  │   ├── instances_train2014.json
  │   ├── instances_train2017.json
  │   ├── instances_val2014.json
  │   ├── instances_val2017.json
  │   |   ...
  ├── train2017
  │   ├── 000000000009.jpg
  │   ├── 000000580008.jpg
  │   |   ...
  ├── val2017
  │   ├── 000000000139.jpg
  │   ├── 000000000285.jpg
  │   |   ...
  |   ...</code></p>
<ul>
<li>Pascal VOC数据源</li>
</ul>
<p>该数据集目前分为VOC2007和VOC2012，主要由xml文件和image文件组成，其组织结构如下所示：</p>
<p><code>dataset/voc/
  ├── train.txt
  ├── val.txt
  ├── test.txt
  ├── label_list.txt (optional)
  ├── VOCdevkit/VOC2007
  │   ├── Annotations
  │       ├── 001789.xml
  │       |   ...
  │   ├── JPEGImages
  │       ├── 001789.xml
  │       |   ...
  │   ├── ImageSets
  │       |   ...
  ├── VOCdevkit/VOC2012
  │   ├── Annotations
  │       ├── 003876.xml
  │       |   ...
  │   ├── JPEGImages
  │       ├── 003876.xml
  │       |   ...
  │   ├── ImageSets
  │       |   ...
  |   ...</code></p>
<p><strong>说明：</strong> 如果你在yaml配置文件中设置<code>use_default_label=False</code>, 将从<code>label_list.txt</code>
中读取类别列表，反之则可以没有<code>label_list.txt</code>文件，检测库会使用Pascal VOC数据集的默
认类别列表，默认类别列表定义在<a href="../ppdet/data/source/voc_loader.py">voc_loader.py</a></p>
<ul>
<li>Roidb数据源
    该数据集主要由COCO数据集和Pascal VOC数据集转换而成的pickle文件，包含一个dict，而dict中只包含一个命名为‘records’的list（可能还有一个命名为‘cname2cid’的字典），其内容如下所示：</li>
</ul>
<pre><code class="python">(records, catname2clsid)
'records'是一个list并且它的结构如下:
{
    'im_file': im_fname, # 图像文件名
    'im_id': im_id, # 图像id
    'h': im_h, # 图像高度
    'w': im_w, # 图像宽度
    'is_crowd': is_crowd, # 是否重叠
    'gt_class': gt_class, # 真实框类别
    'gt_bbox': gt_bbox, # 真实框坐标
    'gt_poly': gt_poly, # 多边形坐标
}
'cname2id'是一个dict，保存了类别名到id的映射

</code></pre>

<p>我们在<code>./tools/</code>中提供了一个生成roidb数据集的代码，可以通过下面命令实现该功能。</p>
<pre><code># --type: 原始数据集的类别（只能是xml或者json）
# --annotation: 一个包含所需标注文件名的文件的路径
# --save-dir: 保存路径
# --samples: sample的个数（默认是-1，代表使用所有sample）
python ./ppdet/data/tools/generate_data_for_training.py
            --type=json \
            --annotation=./annotations/instances_val2017.json \
            --save-dir=./roidb \
            --samples=-1
</code></pre>

<ol>
<li>
<p>图片预处理<br />
    图片预处理通过包括图片解码、缩放、裁剪等操作，我们采用<code>data.transform.operator</code>算子的方式来统一实现，这样能方便扩展。此外，多个算子还可以组合形成复杂的处理流程, 并被<code>data.transformer</code>中的转换器使用，比如多线程完成一个复杂的预处理流程。</p>
</li>
<li>
<p>数据转换器<br />
    数据转换器的功能是完成对某个<code>data.Dataset</code>进行转换处理，从而得到一个新的<code>data.Dataset</code>。我们采用装饰器模式实现各种不同的<code>data.transform.transformer</code>。比如用于多进程预处理的<code>dataset.transform.paralle_map</code>转换器。</p>
</li>
<li>
<p>数据获取接口<br />
     为方便训练时的数据获取，我们将多个<code>data.Dataset</code>组合在一起构成一个<code>data.Reader</code>为用户提供数据，用户只需要调用<code>Reader.[train|eval|infer]</code>即可获得对应的数据流。<code>Reader</code>支持yaml文件配置数据地址、预处理过程、加速方式等。</p>
</li>
</ol>
<h3 id="apis">APIs</h3>
<p>主要的APIs如下：</p>
<ol>
<li>
<p>数据解析  </p>
</li>
<li>
<p><code>source/coco_loader.py</code>：用于解析COCO数据集。<a href="../ppdet/data/source/coco_loader.py">详见代码</a></p>
</li>
<li><code>source/voc_loader.py</code>：用于解析Pascal VOC数据集。<a href="../ppdet/data/source/voc_loader.py">详见代码</a><br />
 [注意]在使用VOC数据集时，若不使用默认的label列表，则需要先使用<code>tools/generate_data_for_training.py</code>生成<code>label_list.txt</code>（使用方式与数据解析中的roidb数据集获取过程一致），或提供<code>label_list.txt</code>放置于<code>data/pascalvoc/ImageSets/Main</code>中；同时在配置文件中设置参数<code>use_default_label</code>为<code>true</code>。</li>
<li>
<p><code>source/loader.py</code>：用于解析Roidb数据集。<a href="../ppdet/data/source/loader.py">详见代码</a></p>
</li>
<li>
<p>算子<br />
<code>transform/operators.py</code>：包含多种数据增强方式，主要包括：  </p>
</li>
</ol>
<pre><code class="python">RandomFlipImage：水平翻转。
RandomDistort：随机扰动图片亮度、对比度、饱和度和色相。
ResizeImage：根据特定的插值方式调整图像大小。
RandomInterpImage：使用随机的插值方式调整图像大小。
CropImage：根据缩放比例、长宽比例两个参数生成若干候选框，再依据这些候选框和标注框的面积交并比(IoU)挑选出符合要求的裁剪结果。
ExpandImage：将原始图片放进一张使用像素均值填充(随后会在减均值操作中减掉)的扩张图中，再对此图进行裁剪、缩放和翻转。
DecodeImage：以RGB格式读取图像。
Permute：对图像的通道进行排列并转为BGR格式。
NormalizeImage：对图像像素值进行归一化。
NormalizeBox：对bounding box进行归一化。
MixupImage：按比例叠加两张图像。
</code></pre>

<p>[注意]：Mixup的操作可参考<a href="https://arxiv.org/pdf/1710.09412.pdf">论文</a>。</p>
<p><code>transform/arrange_sample.py</code>：实现对输入网络数据的排序。<br />
3. 转换<br />
<code>transform/post_map.py</code>：用于完成批数据的预处理操作，其主要包括：</p>
<pre><code class="python">随机调整批数据的图像大小
多尺度调整图像大小
padding操作
</code></pre>

<p><code>transform/transformer.py</code>：用于过滤无用的数据，并返回批数据。
<code>transform/parallel_map.py</code>：用于实现加速。<br />
4. 读取<br />
<code>reader.py</code>：用于组合source和transformer操作，根据<code>max_iter</code>返回batch数据。
<code>data_feed.py</code>: 用于配置 <code>reader.py</code>中所需的默认参数.</p>
<h3 id="_4">使用</h3>
<h4 id="_5">常规使用</h4>
<p>结合yaml文件中的配置信息，完成本模块的功能。yaml文件的使用可以参见配置文件部分。</p>
<ul>
<li>读取用于训练的数据</li>
</ul>
<pre><code class="python">ccfg = load_cfg('./config.yml')
coco = Reader(ccfg.DATA, ccfg.TRANSFORM, maxiter=-1)
</code></pre>

<h4 id="_6">如何使用自定义数据集？</h4>
<ul>
<li>选择1：将数据集转换为COCO格式。</li>
</ul>
<pre><code> # 在./tools/中提供了x2coco.py用于将labelme标注的数据集或cityscape数据集转换为COCO数据集
 python ./ppdet/data/tools/x2coco.py --dataset_type labelme
                                --json_input_dir ./labelme_annos/
                                --image_input_dir ./labelme_imgs/
                                --output_dir ./cocome/
                                --train_proportion 0.8
                                --val_proportion 0.2
                                --test_proportion 0.0
 # --dataset_type：需要转换的数据格式，目前支持：’labelme‘和’cityscape‘
 # --json_input_dir：使用labelme标注的json文件所在文件夹
 # --image_input_dir：图像文件所在文件夹
 # --output_dir：转换后的COCO格式数据集存放位置
 # --train_proportion：标注数据中用于train的比例
 # --val_proportion：标注数据中用于validation的比例
 # --test_proportion: 标注数据中用于infer的比例
</code></pre>

<ul>
<li>
<p>选择2：</p>
</li>
<li>
<p>仿照<code>./source/coco_loader.py</code>和<code>./source/voc_loader.py</code>，添加<code>./source/XX_loader.py</code>并实现<code>load</code>函数。  </p>
</li>
<li>在<code>./source/loader.py</code>的<code>load</code>函数中添加使用<code>./source/XX_loader.py</code>的入口。  </li>
<li>修改<code>./source/__init__.py</code>：  </li>
</ul>
<pre><code class="python">if data_cf['type'] in ['VOCSource', 'COCOSource', 'RoiDbSource']:
    source_type = 'RoiDbSource'
# 将上述代码替换为如下代码：
if data_cf['type'] in ['VOCSource', 'COCOSource', 'RoiDbSource', 'XXSource']:
    source_type = 'RoiDbSource'
</code></pre>

<ol>
<li>在配置文件中修改<code>dataset</code>下的<code>type</code>为<code>XXSource</code>。  </li>
</ol>
<h4 id="_7">如何增加数据预处理？</h4>
<ul>
<li>若增加单张图像的增强预处理，可在<code>transform/operators.py</code>中参考每个类的代码，新建一个类来实现新的数据增强；同时在配置文件中增加该预处理。</li>
<li>若增加单个batch的图像预处理，可在<code>transform/post_map.py</code>中参考<code>build_post_map</code>中每个函数的代码，新建一个内部函数来实现新的批数据预处理；同时在配置文件中增加该预处理。</li>
</ul>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../mathjax-config.js" defer></script>
      <script src="../MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
